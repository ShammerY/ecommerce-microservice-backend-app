pipeline {
    agent any

    environment {
        KUBE_NAMESPACE = "production"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Deploy All Microservices') {
            steps {
                script {
                    // ‚úÖ Definimos la lista de microservicios aqu√≠ (no en environment)
                    def SERVICES = [
                        "user-service",
                        "order-service",
                        "shipping-service",
                        "payment-service",
                        "api-gateway"
                    ]

                    for (service in SERVICES) {
                        echo "üöÄ Iniciando deployment para ${service}..."

                        // Cambiamos el directorio al microservicio actual
                        dir("${service}") {
                            try {
                                echo "üì¶ Compilando y desplegando ${service}..."

                                // Ejecutar Maven dentro de contenedor oficial
                                docker.image('maven:3.8.4-openjdk-11').inside('-v $PWD:/workspace -w /workspace') {
                                    sh "mvn clean test -f pom.xml"
                                }

                                // Construir y subir imagen Docker
                                sh "docker build -t shammery/${service}:v${env.BUILD_NUMBER} ."
                                sh "docker push shammery/${service}:v${env.BUILD_NUMBER}"

                                // Aplicar despliegue en Kubernetes
                                sh "kubectl apply -f ../k8s/${service}-prod.yaml -n ${KUBE_NAMESPACE}"
                                sh "kubectl rollout status deployment/${service} -n ${KUBE_NAMESPACE}"

                            } catch (err) {
                                error "‚ùå Error al desplegar ${service}: ${err}"
                            }
                        }
                    }
                }
            }
        }

        stage('Verification') {
            steps {
                script {
                    echo "üîç Verificando servicios activos..."
                    sh "kubectl get pods -n ${KUBE_NAMESPACE}"
                    sh "kubectl get svc -n ${KUBE_NAMESPACE}"
                }
            }
        }

        stage('Generate Global Release Notes') {
            steps {
                script {
                    echo "üìù Generando release notes global..."
                    sh '''
                        echo "### Release v${BUILD_NUMBER} - $(date)" > release_notes_master.md
                        for service in user-service order-service shipping-service payment-service api-gateway; do
                            echo "- Deployed $service" >> release_notes_master.md
                        done
                        echo "" >> release_notes_master.md
                    '''
                    archiveArtifacts artifacts: 'release_notes_master.md', fingerprint: true
                }
            }
        }
    }

    post {
        success {
            echo "‚úÖ Todos los microservicios fueron desplegados exitosamente en producci√≥n."
        }
        failure {
            echo "‚ùå El despliegue general fall√≥. Iniciando rollback..."
            script {
                def rollbackServices = [
                    "user-service",
                    "order-service",
                    "shipping-service",
                    "payment-service",
                    "api-gateway"
                ]
                for (service in rollbackServices) {
                    sh "kubectl rollout undo deployment/${service} -n ${KUBE_NAMESPACE} || true"
                }
            }
        }
    }
}
